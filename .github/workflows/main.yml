name: Build and test

on: push

env:
  LANG: en_US.UTF-8
  UV_FROZEN: true

defaults:
  run:
    shell: bash

permissions: {}

jobs:
  checks:
    permissions:
      contents: read # checkout
      pull-requests: write # reviewdog
    runs-on: ubuntu-22.04
    container: globeswiss/cloud-sdk:py3.12.12-554.0.0
    steps:
      - uses: actions/checkout@v6.0.2
        with:
          persist-credentials: false
      - name: Install uv
        uses: astral-sh/setup-uv@v7.3.0
      - name: Sync dev dependencies
        run: uv sync
      - name: Check requirements file
        run: diff -w <(uv export --format requirements-txt --no-hashes --no-dev | grep '==') <(grep '==' requirements.txt)
      - name: Check bandit
        run: uv run bandit -r test phenoback main.py -c .bandit
        if: always()
      - name: Check pylint
        run: uv run pylint --reports=y phenoback test main.py
        if: always()
      - name: Check black
        uses: reviewdog/action-black@v3.22.4
        with:
          reporter: github-check
          verbose: True
          fail_on_error: True
        if: always()
      - name: Check markdownlint
        uses: reviewdog/action-markdownlint@v0.26.2
        with:
          reporter: github-check
          fail_level: warning
        if: always()
  test:
    permissions:
      id-token: write # codecov oidc
      contents: read # checkout
    runs-on: ubuntu-22.04
    container: globeswiss/cloud-sdk:py3.12.12-554.0.0
    steps:
      - uses: actions/checkout@v6.0.2
        with:
          persist-credentials: false
      - name: Install uv
        uses: astral-sh/setup-uv@v7.3.0
      - name: Sync dev dependencies
        run: uv sync
      - name: Run pytest
        run: uv run python -m pytest --cov-report xml --cov=main --cov=phenoback --cov-branch
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5.5.2
        with:
          use_oidc: true
          files: ./coverage.xml
          flags: unittests
        if: always()
  zizmor:
    runs-on: ubuntu-22.04
    permissions:
      security-events: write
      contents: read # only needed for private repos
      actions: read # only needed for private repos
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6.0.2
        with:
          persist-credentials: false
      - name: Run zizmor ðŸŒˆ
        uses: zizmorcore/zizmor-action@v0.5.0
